package {{txtConfigPackage}};

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import javax.sql.DataSource;

import org.springframework.aop.Advisor;
import org.springframework.aop.aspectj.AspectJExpressionPointcut;
import org.springframework.aop.support.DefaultPointcutAdvisor;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.EnableAspectJAutoProxy;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.transaction.TransactionDefinition;
import org.springframework.transaction.annotation.EnableTransactionManagement;
import org.springframework.transaction.interceptor.NameMatchTransactionAttributeSource;
import org.springframework.transaction.interceptor.NoRollbackRuleAttribute;
import org.springframework.transaction.interceptor.RollbackRuleAttribute;
import org.springframework.transaction.interceptor.RuleBasedTransactionAttribute;
import org.springframework.transaction.interceptor.TransactionAttribute;
import org.springframework.transaction.interceptor.TransactionInterceptor;
import org.springframework.transaction.support.TransactionTemplate;

@Configuration
{{#if (eq transactionManagementType "aopConfigTransaction")}}
@EnableAspectJAutoProxy(proxyTargetClass = true) // 포인트컷/어드바이저 동작
{{/if~}}
{{#if (eq transactionManagementType "annotationTransaction")}}
@EnableTransactionManagement // 어노테이션(@Transactional) 기반 트랜잭션 관리
{{/if~}}
public class {{txtFileName}} {

    @Bean(name = "{{txtTransactionName}}")
    public DataSourceTransactionManager txManager(@Qualifier("{{txtDataSourceName}}") DataSource dataSource) {
        DataSourceTransactionManager dataSourceTransactionManager = new DataSourceTransactionManager();
        dataSourceTransactionManager.setDataSource(dataSource);
        return dataSourceTransactionManager;
    }

    {{#if (trim txtTransactionTemplateName)}}
    @Bean(name = "{{txtTransactionTemplateName}}")
    public TransactionTemplate transactionTemplate(@Qualifier("{{txtTransactionName}}") DataSourceTransactionManager transactionManager) {
       return new TransactionTemplate(transactionManager);
    }
    {{/if}}

    {{#if (eq transactionManagementType "aopConfigTransaction")}}
    @Bean(name = "{{txtAdviceName}}")
    public TransactionInterceptor txAdvice(@Qualifier("{{txtTransactionName}}") DataSourceTransactionManager transactionManager) {
        TransactionInterceptor txAdvice = new TransactionInterceptor();
        txAdvice.setTransactionManager(transactionManager);
        txAdvice.setTransactionAttributeSource(getNameMatchTransactionAttributeSource());
        return txAdvice;
    }

    private NameMatchTransactionAttributeSource getNameMatchTransactionAttributeSource() {
        NameMatchTransactionAttributeSource txAttributeSource = new NameMatchTransactionAttributeSource();
        txAttributeSource.setNameMap(getRuleBasedTxAttributeMap());
        return txAttributeSource;
    }

    private HashMap<String, TransactionAttribute> getRuleBasedTxAttributeMap() {
        HashMap<String, TransactionAttribute> txMethods = new HashMap<String, TransactionAttribute>();

        RuleBasedTransactionAttribute txAttribute = new RuleBasedTransactionAttribute();
        txAttribute.setPropagationBehavior(TransactionDefinition.PROPAGATION_{{cmbPropagation}});
        txAttribute.setIsolationLevel(TransactionDefinition.ISOLATION_{{cmbIsolation}});
        {{#if chkReadOnly}}
        txAttribute.setReadOnly({{chkReadOnly}});
        {{/if}}

        {{#if (or (trim txtRollbackFor) (trim txtNoRollbackFor))}}
        List<RollbackRuleAttribute> rollbackRules = new ArrayList<>();
            {{#if (trim txtRollbackFor)}}
        rollbackRules.add(new RollbackRuleAttribute({{txtRollbackFor}}.class));
            {{/if}}
            {{#if (trim txtNoRollbackFor)}}
        rollbackRules.add(new NoRollbackRuleAttribute({{txtNoRollbackFor}}.class));
            {{/if}}

        txAttribute.setRollbackRules(rollbackRules);
        {{/if}}

        {{#if (trim txtTimeout)}}
        txAttribute.setTimeout({{txtTimeout}});
        {{/if}}

        txMethods.put("{{txtMethodName}}", txAttribute);
        return txMethods;
    }

    // TransactionAdvisor 설정
    @Bean
    public Advisor txAdvisor(@Qualifier("{{txtTransactionName}}") DataSourceTransactionManager txManager) {
        AspectJExpressionPointcut pointcut = new AspectJExpressionPointcut();
        pointcut.setExpression("{{txtPointCutExpression}}");
        return new DefaultPointcutAdvisor(pointcut, txAdvice(txManager));
    }
    {{/if}}
}
